<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DGUV Compliance Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ DGUV Compliance Integration Test</h1>
    <p>Diese Seite testet die Integration der DGUV-Module in das QHSE-System.</p>

    <div class="test-container">
        <h2>üîç Modul-Tests</h2>
        <button onclick="testModuleLoading()">Module laden testen</button>
        <button onclick="testDGUVGeneration()">DGUV Form 1 Generation</button>
        <button onclick="testPDFGeneration()">PDF Generation testen</button>
        <button onclick="testCompanyData()">Firmendaten testen</button>
        <div id="testResults"></div>
    </div>

    <div class="test-container">
        <h2>üìã Dummy Incident Test</h2>
        <button onclick="createTestIncident()">Test-Unfall erstellen</button>
        <button onclick="exportTestToDGUV()">Test zu DGUV exportieren</button>
        <div id="incidentResults"></div>
    </div>

    <div class="test-container">
        <h2>üìä Systemstatus</h2>
        <div id="systemStatus"></div>
    </div>

    <!-- Load dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="compliance-dguv-form1.js"></script>
    <script src="compliance-dguv-pdf.js"></script>

    <script>
        let testIncident = null;
        let dguvGenerator = null;
        let pdfGenerator = null;

        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(message);
        }

        function testModuleLoading() {
            log('üîÑ Teste Modul-Loading...', 'info');
            
            // Test jsPDF
            if (typeof window.jsPDF !== 'undefined') {
                log('‚úÖ jsPDF erfolgreich geladen', 'success');
            } else {
                log('‚ùå jsPDF nicht verf√ºgbar', 'error');
                return;
            }

            // Test DGUV Form 1 Generator
            if (typeof window.DGUVForm1Generator !== 'undefined') {
                dguvGenerator = new DGUVForm1Generator();
                log('‚úÖ DGUV Form 1 Generator erfolgreich geladen', 'success');
            } else {
                log('‚ùå DGUV Form 1 Generator nicht verf√ºgbar', 'error');
            }

            // Test DGUV PDF Generator
            if (typeof window.DGUVPDFGenerator !== 'undefined') {
                pdfGenerator = new DGUVPDFGenerator();
                log('‚úÖ DGUV PDF Generator erfolgreich geladen', 'success');
            } else {
                log('‚ùå DGUV PDF Generator nicht verf√ºgbar', 'error');
            }

            updateSystemStatus();
        }

        function testCompanyData() {
            log('üè¢ Teste Firmendaten...', 'info');
            
            const companyData = {
                name: 'QHSE GFT Testfirma',
                address: 'Teststra√üe 123',
                postalCode: '12345',
                city: 'Teststadt',
                phone: '+49 123 456789',
                email: 'info@qhse-gft.de',
                membershipNumber: 'BG01123456',
                industryCode: '88999'
            };

            log(`Firmendaten: ${JSON.stringify(companyData, null, 2)}`, 'info');
            return companyData;
        }

        function createTestIncident() {
            log('üö® Erstelle Test-Unfall...', 'info');
            
            testIncident = {
                id: 'test-incident-' + Date.now(),
                incidentDateTime: new Date().toISOString(),
                incidentLocation: 'Produktionshalle A',
                incidentDescription: 'Sturz von der Leiter w√§hrend Wartungsarbeiten',
                incidentSeverity: 'mittel',
                reporterName: 'Max Mustermann',
                reporterDepartment: 'Produktion',
                reporterPosition: 'Abteilungsleiter',
                reporterPhone: '+49 123 456789',
                reporterEmail: 'max.mustermann@qhse-gft.de',
                workProcess: 'Wartung der Produktionsanlage',
                accidentCause: 'Rutschige Sprossen der Leiter',
                witnesses: 'Anna Schmidt, Peter M√ºller',
                persons: {
                    lastName: 'Mustermann',
                    firstName: 'Max',
                    birthDate: '15.03.1985',
                    gender: 'm',
                    nationality: 'deutsch',
                    address: 'Musterstra√üe 45',
                    postalCode: '12345',
                    city: 'Teststadt',
                    personnelNumber: 'P001234',
                    jobTitle: 'Abteilungsleiter',
                    employmentStart: '01.01.2020',
                    workingHoursPerWeek: '40'
                },
                consequences: {
                    bodyPart: 'Linker Arm',
                    injuryType: 'Prellung und Sch√ºrfwunden',
                    injuries: 'Prellung am linken Unterarm mit oberfl√§chlichen Sch√ºrfwunden',
                    firstAid: true,
                    doctorTreatment: true,
                    hospitalTreatment: false,
                    workIncapacity: true,
                    workdaysLost: 3
                }
            };

            const incidentResults = document.getElementById('incidentResults');
            incidentResults.innerHTML = `
                <div class="test-result success">
                    ‚úÖ Test-Unfall erstellt: ${testIncident.id}
                    <pre>${JSON.stringify(testIncident, null, 2)}</pre>
                </div>
            `;

            log('‚úÖ Test-Unfall erfolgreich erstellt', 'success');
        }

        function testDGUVGeneration() {
            if (!dguvGenerator) {
                log('‚ùå DGUV Generator nicht verf√ºgbar', 'error');
                return;
            }

            if (!testIncident) {
                log('‚ö†Ô∏è Erstelle erst einen Test-Unfall', 'error');
                return;
            }

            log('üìã Teste DGUV Form 1 Generierung...', 'info');

            try {
                const companyData = testCompanyData();
                const dguvData = dguvGenerator.generateDGUVForm1(testIncident, companyData);

                if (dguvData && !dguvData.error) {
                    log('‚úÖ DGUV Form 1 erfolgreich generiert', 'success');
                    log(`Validierung: ${dguvData.validation.isValid ? 'G√ºltig' : 'Ung√ºltig'}`, dguvData.validation.isValid ? 'success' : 'error');
                    log(`Vollst√§ndigkeit: ${dguvData.validation.completeness}%`, 'info');
                    
                    if (dguvData.validation.errors.length > 0) {
                        log(`Fehler: ${dguvData.validation.errors.join(', ')}`, 'error');
                    }
                    
                    if (dguvData.validation.warnings.length > 0) {
                        log(`Warnungen: ${dguvData.validation.warnings.join(', ')}`, 'info');
                    }

                    // Show generated data
                    const pre = document.createElement('pre');
                    pre.textContent = JSON.stringify(dguvData, null, 2);
                    document.getElementById('testResults').appendChild(pre);

                } else {
                    log('‚ùå DGUV Generierung fehlgeschlagen: ' + (dguvData.message || 'Unbekannter Fehler'), 'error');
                }
            } catch (error) {
                log('‚ùå Fehler bei DGUV Generierung: ' + error.message, 'error');
            }
        }

        function testPDFGeneration() {
            if (!pdfGenerator || !dguvGenerator) {
                log('‚ùå PDF Generator oder DGUV Generator nicht verf√ºgbar', 'error');
                return;
            }

            if (!testIncident) {
                log('‚ö†Ô∏è Erstelle erst einen Test-Unfall', 'error');
                return;
            }

            log('üìÑ Teste PDF Generierung...', 'info');

            try {
                const companyData = testCompanyData();
                const dguvData = dguvGenerator.generateDGUVForm1(testIncident, companyData);

                if (dguvData && !dguvData.error && dguvData.validation.isValid) {
                    pdfGenerator.generatePDF(dguvData, { download: true })
                        .then(result => {
                            log('‚úÖ PDF erfolgreich generiert und heruntergeladen: ' + result.filename, 'success');
                        })
                        .catch(error => {
                            log('‚ùå PDF-Generierung fehlgeschlagen: ' + error.message, 'error');
                        });
                } else {
                    log('‚ùå Kann PDF nicht generieren - DGUV Daten ung√ºltig', 'error');
                }
            } catch (error) {
                log('‚ùå Fehler bei PDF Generierung: ' + error.message, 'error');
            }
        }

        function exportTestToDGUV() {
            if (!testIncident || !dguvGenerator || !pdfGenerator) {
                log('‚ùå Test-Unfall oder DGUV Module nicht verf√ºgbar', 'error');
                return;
            }

            log('üìã Exportiere Test-Unfall zu DGUV...', 'info');

            try {
                const companyData = testCompanyData();
                const dguvData = dguvGenerator.generateDGUVForm1(testIncident, companyData);

                if (dguvData && !dguvData.error) {
                    pdfGenerator.generatePDF(dguvData, { download: true })
                        .then(result => {
                            log('‚úÖ DGUV Export erfolgreich: ' + result.filename, 'success');
                            
                            const incidentResults = document.getElementById('incidentResults');
                            incidentResults.innerHTML += `
                                <div class="test-result success">
                                    üìÑ DGUV PDF exportiert: ${result.filename}
                                </div>
                            `;
                        })
                        .catch(error => {
                            log('‚ùå DGUV Export fehlgeschlagen: ' + error.message, 'error');
                        });
                } else {
                    log('‚ùå DGUV Export fehlgeschlagen: ' + (dguvData.message || 'Unbekannter Fehler'), 'error');
                }
            } catch (error) {
                log('‚ùå Fehler beim DGUV Export: ' + error.message, 'error');
            }
        }

        function updateSystemStatus() {
            const status = document.getElementById('systemStatus');
            const modules = [
                { name: 'jsPDF', available: typeof window.jsPDF !== 'undefined' },
                { name: 'DGUV Form 1 Generator', available: typeof window.DGUVForm1Generator !== 'undefined' },
                { name: 'DGUV PDF Generator', available: typeof window.DGUVPDFGenerator !== 'undefined' }
            ];

            let html = '<h3>Module Status:</h3>';
            modules.forEach(module => {
                html += `<div class="test-result ${module.available ? 'success' : 'error'}">
                    ${module.available ? '‚úÖ' : '‚ùå'} ${module.name}
                </div>`;
            });

            status.innerHTML = html;
        }

        // Auto-load modules on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                testModuleLoading();
            }, 500);
        });
    </script>
</body>
</html>