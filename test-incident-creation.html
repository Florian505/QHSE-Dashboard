<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Incident Creation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🧪 Test Incident Creation & Overview</h1>
    
    <div class="test-container">
        <h2>Teste Incident Overview Funktionalität</h2>
        <p>Dieser Test erstellt Beispiel-Unfälle und Beinahe-Unfälle zum Testen der neuen "Vorfälle verwalten" Sektion.</p>
        
        <button onclick="createTestIncidents()">📋 Test-Vorfälle erstellen</button>
        <button onclick="clearAllIncidents()">🗑️ Alle Vorfälle löschen</button>
        <button onclick="checkIncidentCount()">📊 Anzahl prüfen</button>
        <button onclick="openMainSystem()">🏠 Hauptsystem öffnen</button>
        
        <div id="testResults"></div>
    </div>

    <script>
        function createTestIncidents() {
            log('🚀 Erstelle Test-Vorfälle...');
            
            const testIncidents = [
                // Unfall 1
                {
                    id: 'test-accident-' + Date.now() + '-1',
                    type: 'accident',
                    incidentDateTime: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(), // 5 Tage her
                    incidentLocation: 'Produktionshalle A, Arbeitsplatz 12',
                    incidentDescription: 'Mitarbeiter ist von der Leiter gefallen während der Wartung der Maschine XY-450. Der Mitarbeiter rutschte auf der 3. Sprosse aus und fiel ca. 2 Meter tief. Sofortige erste Hilfe wurde geleistet.',
                    severity: 'mittel',
                    status: 'in_bearbeitung',
                    reporterName: 'Max Mustermann',
                    reporterDepartment: 'Produktion',
                    reporterPosition: 'Abteilungsleiter',
                    affectedPersonName: 'Thomas Schmidt',
                    immediateMeasures: 'Erste Hilfe geleistet, Rettungsdienst verständigt, Arbeitsplatz abgesperrt, Leiter aus dem Verkehr gezogen',
                    preventiveMeasures: 'Leiter-Inspektion verstärken, rutschfeste Sprossen installieren, Sicherheitstraining für alle Mitarbeiter',
                    witnesses: 'Anna Weber, Peter Müller',
                    createdAt: new Date().toISOString()
                },
                
                // Unfall 2
                {
                    id: 'test-accident-' + Date.now() + '-2',
                    type: 'accident',
                    incidentDateTime: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2 Tage her
                    incidentLocation: 'Lager B, Gang 7',
                    incidentDescription: 'Schnittverletzung an der rechten Hand beim Öffnen einer Verpackung mit defektem Cutter-Messer. Die Klinge war stumpf und ist abgerutscht.',
                    severity: 'niedrig',
                    status: 'abgeschlossen',
                    reporterName: 'Lisa Wagner',
                    reporterDepartment: 'Logistik',
                    reporterPosition: 'Lagermitarbeiterin',
                    affectedPersonName: 'Lisa Wagner',
                    immediateMeasures: 'Wunde desinfiziert und verbunden, Betriebssanitäter informiert',
                    preventiveMeasures: 'Regelmäßiger Austausch der Cutter-Klingen, Sicherheitshandschuhe bereitstellen',
                    witnesses: '',
                    createdAt: new Date().toISOString()
                },
                
                // Beinahe-Unfall 1
                {
                    id: 'test-nearmiss-' + Date.now() + '-1',
                    type: 'near_miss',
                    incidentDateTime: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), // 1 Tag her
                    incidentLocation: 'Eingangsbereich Hauptgebäude',
                    incidentDescription: 'Palette mit Waren war instabil gestapelt und drohte umzufallen. Ein Mitarbeiter bemerkte die Gefahr rechtzeitig und konnte die Palette stabilisieren. Keine Verletzungen.',
                    severity: 'niedrig',
                    status: 'offen',
                    reporterName: 'Peter Weber',
                    reporterDepartment: 'Logistik',
                    reporterPosition: 'Staplerfahrer',
                    affectedPersonName: '',
                    immediateMeasures: 'Palette neu gestapelt und gesichert, Bereich temporär abgesperrt',
                    preventiveMeasures: 'Schulung zu korrekter Palettenstapelung, bessere Kennzeichnung von Stapelgrenzen',
                    witnesses: 'Maria Rodriguez',
                    createdAt: new Date().toISOString()
                },
                
                // Beinahe-Unfall 2
                {
                    id: 'test-nearmiss-' + Date.now() + '-2',
                    type: 'near_miss',
                    incidentDateTime: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(), // 1 Woche her
                    incidentLocation: 'Werkstatt, Drehbank 3',
                    incidentDescription: 'Während der Bearbeitung eines Werkstücks löste sich die Spannvorrichtung. Das Werkstück flog durch die Werkstatt, verfehlte aber knapp einen Kollegen. Maschine wurde sofort gestoppt.',
                    severity: 'hoch',
                    status: 'in_bearbeitung',
                    reporterName: 'Klaus Hoffmann',
                    reporterDepartment: 'Fertigung',
                    reporterPosition: 'Werkstattleiter',
                    affectedPersonName: '',
                    immediateMeasures: 'Maschine stillgelegt, Sicherheitsbereich erweitert, technische Prüfung eingeleitet',
                    preventiveMeasures: 'Wartungsintervalle verkürzen, zusätzliche Schutzvorrichtungen installieren, Schulung zu Spannvorrichtungen',
                    witnesses: 'Frank Neumann, Sandra Klein',
                    createdAt: new Date().toISOString()
                },
                
                // Kritischer Unfall
                {
                    id: 'test-critical-' + Date.now() + '-1',
                    type: 'accident',
                    incidentDateTime: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(), // 3 Stunden her
                    incidentLocation: 'Chemielager, Regal 15',
                    incidentDescription: 'Beim Transport von Chemikalien ist ein Behälter mit Säure undicht geworden. Der Mitarbeiter erlitt Verätzungen an Händen und Unterarmen. Sofortige Notfallmaßnahmen eingeleitet.',
                    severity: 'kritisch',
                    status: 'offen',
                    reporterName: 'Dr. Sarah Meyer',
                    reporterDepartment: 'Qualitätskontrolle',
                    reporterPosition: 'Labourleitung',
                    affectedPersonName: 'Michael Braun',
                    immediateMeasures: 'Notarzt gerufen, betroffene Bereiche gespült, Chemielager evakuiert, Feuerwehr informiert',
                    preventiveMeasures: 'Behälter-Prüfungsverfahren überarbeiten, verstärkte Schutzausrüstung, Notfallverfahren trainieren',
                    witnesses: 'Jennifer Schmidt, Robert Fischer',
                    createdAt: new Date().toISOString()
                }
            ];
            
            // Speichere in localStorage
            try {
                const existingIncidents = JSON.parse(localStorage.getItem('qhse_incidents') || '[]');
                const newIncidents = [...existingIncidents, ...testIncidents];
                localStorage.setItem('qhse_incidents', JSON.stringify(newIncidents));
                
                log(`✅ ${testIncidents.length} Test-Vorfälle erfolgreich erstellt!`);
                log(`📊 Gesamt in localStorage: ${newIncidents.length} Vorfälle`);
                
                // Zeige Zusammenfassung
                const summary = testIncidents.reduce((acc, inc) => {
                    acc[inc.type] = (acc[inc.type] || 0) + 1;
                    return acc;
                }, {});
                
                log(`📋 Erstellt: ${summary.accident || 0} Unfälle, ${summary.near_miss || 0} Beinahe-Unfälle`);
                
            } catch (error) {
                log(`❌ Fehler beim Speichern: ${error.message}`);
            }
        }
        
        function clearAllIncidents() {
            if (confirm('Alle Vorfälle löschen? Diese Aktion kann nicht rückgängig gemacht werden.')) {
                localStorage.removeItem('qhse_incidents');
                log('🗑️ Alle Vorfälle wurden gelöscht');
            }
        }
        
        function checkIncidentCount() {
            try {
                const incidents = JSON.parse(localStorage.getItem('qhse_incidents') || '[]');
                const accidents = incidents.filter(inc => inc.type === 'accident').length;
                const nearMiss = incidents.filter(inc => inc.type === 'near_miss').length;
                
                log(`📊 Aktueller Stand:`);
                log(`   • Gesamt: ${incidents.length} Vorfälle`);
                log(`   • Unfälle: ${accidents}`);
                log(`   • Beinahe-Unfälle: ${nearMiss}`);
                
                // Zeige Status-Verteilung
                const statusCount = incidents.reduce((acc, inc) => {
                    const status = inc.status || 'offen';
                    acc[status] = (acc[status] || 0) + 1;
                    return acc;
                }, {});
                
                log(`   • Status: ${JSON.stringify(statusCount)}`);
                
            } catch (error) {
                log(`❌ Fehler beim Laden: ${error.message}`);
            }
        }
        
        function openMainSystem() {
            window.open('index.html', '_blank');
        }
        
        function log(message) {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = message.includes('✅') ? 'success' : 'info';
            div.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;
            results.appendChild(div);
            console.log(message);
            
            // Keep only last 15 entries
            while (results.children.length > 15) {
                results.removeChild(results.firstChild);
            }
        }
        
        // Auto-check on page load
        window.addEventListener('load', () => {
            checkIncidentCount();
        });
    </script>
</body>
</html>